# --- memory (192g) ---
shared_buffers                   = 48GB          # ~25%
effective_cache_size             = 128GB         # planner hint (os cache)
work_mem                         = 32MB          # global; bump per-session for heavy plans
maintenance_work_mem             = 4GB

# huge pages
huge_pages                       = on           # flip to 'on' after reserving pages (see cmds below)

# --- wal / checkpoints ---
wal_level                        = replica
wal_compression                  = on
wal_buffers                      = -1            # auto; ~64â€“128MB typical. set 128MB if you want fixed
checkpoint_timeout               = 20min
max_wal_size                     = 192GB         # stretch to avoid ckpt storms
min_wal_size                     = 8GB
checkpoint_completion_target     = 0.9
synchronous_commit               = remote_write  # 'on' for max durability; 'off' for max tps

# --- parallel / workers (96 vcpu) ---
max_worker_processes             = 96
max_parallel_workers             = 48
max_parallel_workers_per_gather  = 8
max_parallel_maintenance_workers = 8

# --- autovacuum (global) ---
autovacuum                       = on
autovacuum_max_workers           = 10            # single hot table: more workers won't help
autovacuum_naptime               = 10s
autovacuum_vacuum_cost_limit     = 5000
autovacuum_vacuum_cost_delay     = 2ms

# --- io / planner ---
effective_io_concurrency         = 200           # ssd/ebs
random_page_cost                 = 1.1
seq_page_cost                    = 1.0
default_statistics_target        = 200
jit                              = off           # oltp latency

# --- logging / observability ---
track_io_timing = off                    # save 1-5% if IOPS-bound
log_autovacuum_min_duration = 1000       # only log vacuums >1s (reduce log spam)
log_checkpoints                  = on
log_min_duration_statement       = 250ms
shared_preload_libraries         = 'pg_stat_statements'
pg_stat_statements.max           = 10000
pg_stat_statements.track         = all

# --- connections ---
max_connections                  = 500
superuser_reserved_connections   = 10
